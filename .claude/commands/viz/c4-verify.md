# C4 Architecture Verification

Validate the accuracy and completeness of a hierarchical C4 architecture map.

## Prerequisites

Hierarchical C4 model must exist in `codemap/<system-id>/` folder (generated by `/viz/c4-map`).

## Orchestration Strategy

This command uses **parallel verification with synthesis** - independent checks run in parallel,
then a synthesis phase cross-references findings to identify conflicts and prioritize fixes:

```
                    ┌─────────────────────┐
                    │  Phase 1: Parallel  │
                    │    Verification     │
                    └─────────┬───────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌───────────────┐   ┌───────────────┐   ┌───────────────┐
│ Completeness  │   │   Accuracy    │   │   Hierarchy   │
│    Check      │   │    Check      │   │  Validation   │
└───────┬───────┘   └───────┬───────┘   └───────┬───────┘
        │                     │                     │
        └─────────────────────┼─────────────────────┘
                              │
                              ▼
                    ┌───────────────┐
                    │ Diagram Check │
                    └───────┬───────┘
                              │
        ┌─────────────────────┴─────────────────────┐
        │                                           │
        ▼                                           ▼
┌───────────────────────────────────────────────────────────┐
│                  Phase 2: Synthesis                       │
│  - Find intersections (same issue from multiple checks)   │
│  - Identify conflicts (contradictory findings)            │
│  - Prioritize by severity and frequency                   │
│  - Create unified correction plan                         │
└─────────────────────────────┬─────────────────────────────┘
                              │
                              ▼
┌───────────────────────────────────────────────────────────┐
│                  Phase 3: Apply Fixes                     │
│  - Execute corrections in dependency order                │
│  - Structural changes before content changes              │
└─────────────────────────────┬─────────────────────────────┘
                              │
                              ▼
┌───────────────────────────────────────────────────────────┐
│                  Phase 4: Re-Verification                 │
│  - Quick pass to confirm fixes worked                     │
│  - Flag any remaining issues                              │
└───────────────────────────────────────────────────────────┘
```

**Why parallel then synthesize?**
- Verification checks are independent (reading existing files, not modifying)
- Parallel execution is faster and doesn't cause conflicts
- Synthesis finds issues reported by multiple checks (higher confidence)
- Conflicts between checks reveal inconsistencies in the model itself

---

## PHASE 0: Preparation

Before launching verification subagents, gather the C4 model state.

```bash
# Find the system folder
SYSTEM_ID=$(ls codemap/ | head -1)
echo "System ID: $SYSTEM_ID"

# List the complete hierarchy
find codemap/$SYSTEM_ID -type f \( -name "*.md" -o -name "*.puml" \) | sort

# Count elements at each level
echo "Containers: $(find codemap/$SYSTEM_ID/containers -maxdepth 1 -type d | wc -l)"
echo "Components: $(find codemap/$SYSTEM_ID -type d -name components -exec ls {} \; | wc -l)"
echo "Code folders: $(find codemap/$SYSTEM_ID -type d -name code | wc -l)"
```

Read key files to provide context to subagents:
- `codemap/README.md`
- `codemap/<system-id>/context.md`
- Sample container, component, and code files

---

## PHASE 1: Parallel Verification Checks

Launch ALL FOUR verification subagents IN PARALLEL in a single message.
These are independent checks that only read files.

### Subagent 1: Completeness Check

```
Tool: Task
Parameters:
  subagent_type: "Explore"
  description: "Verify C4 completeness"
  prompt: |
    TASK: Verify COMPLETENESS of the hierarchical C4 map against the actual codebase.

    SYSTEM_ID: <from Phase 0>
    EXISTING HIERARCHY:
    <insert file listing from Phase 0>

    COMPLETENESS DIMENSIONS:

    1. CONTAINER COMPLETENESS:
       - Find all deployable units in codebase
       - Check each has a folder in codemap/<system-id>/containers/
       - Identify missing container folders

    2. COMPONENT COMPLETENESS:
       - For each container, list major modules in source code
       - Check each has a folder in containers/<container-id>/components/
       - Identify missing component folders

    3. CODE COMPLETENESS:
       - For each component, identify key classes
       - Check important classes are documented in code/ folders
       - Note: NOT every class needs documentation, only key ones

    4. EXTERNAL SYSTEM COMPLETENESS:
       - Find all external integrations in codebase
       - Check each appears in context.puml
       - Identify missing external systems

    SEARCH STRATEGY:
    - Glob: **/Dockerfile, **/docker-compose.yml (containers)
    - List directories under main source folder (components)
    - Grep: "class \w+", "import.*azure", "requests\." (code, externals)
    - Compare findings against codemap folder structure

    OUTPUT FORMAT:
    ```json
    {
      "check_type": "completeness",
      "score": "X/4",
      "findings": {
        "containers": {
          "expected": ["api-server", "database", "worker"],
          "documented": ["api-server", "database"],
          "missing": ["worker"],
          "evidence": {"worker": "Found Dockerfile.worker at ./worker/Dockerfile"}
        },
        "components": {
          "by_container": {
            "api-server": {
              "expected": ["auth", "chat", "config", "metrics"],
              "documented": ["auth", "chat", "config"],
              "missing": ["metrics"],
              "evidence": {"metrics": "Found metrics module at ingenious/services/metrics/"}
            }
          }
        },
        "code": {
          "by_component": {
            "auth": {
              "key_classes_expected": ["JWTHandler", "BasicAuthMiddleware", "OAuth2Client"],
              "documented": ["JWTHandler", "BasicAuthMiddleware"],
              "missing": ["OAuth2Client"],
              "evidence": {"OAuth2Client": "Found at ingenious/auth/oauth.py:45"}
            }
          }
        },
        "external_systems": {
          "expected": ["Azure OpenAI", "Azure Search", "Redis"],
          "documented": ["Azure OpenAI", "Azure Search"],
          "missing": ["Redis"],
          "evidence": {"Redis": "Found redis import at ingenious/cache/client.py:3"}
        }
      },
      "issues": [
        {
          "id": "COMP-001",
          "severity": "high",
          "category": "missing_container",
          "description": "Worker container not documented",
          "location": "codemap/<system-id>/containers/",
          "fix": "Create containers/worker/ folder with container.puml and container.md"
        }
      ]
    }
    ```
```

### Subagent 2: Accuracy Check

```
Tool: Task
Parameters:
  subagent_type: "Explore"
  description: "Verify C4 accuracy"
  prompt: |
    TASK: Verify ACCURACY of the hierarchical C4 map against the actual codebase.

    SYSTEM_ID: <from Phase 0>
    EXISTING HIERARCHY:
    <insert file listing from Phase 0>

    ACCURACY DIMENSIONS:

    1. RELATIONSHIP ACCURACY:
       - For each relationship in diagrams, verify it exists in code
       - Check import statements match documented dependencies
       - Verify API calls match container relationships

    2. TECHNOLOGY LABELS:
       - Check framework versions match pyproject.toml/package.json
       - Verify database types match connection code
       - Validate protocol labels (REST, gRPC, SQL, etc.)

    3. HIERARCHY PLACEMENT:
       - Verify components are in correct container folders
       - Verify classes are documented under correct components
       - Find misplaced elements

    4. NAMING ACCURACY:
       - Compare documented names to actual module/class names
       - Find outdated or incorrect names
       - Check source_path fields point to existing locations

    SEARCH STRATEGY:
    - Read .puml files and extract relationships
    - Grep for import statements to verify dependencies
    - Read pyproject.toml for version numbers
    - Check file paths in documentation exist

    OUTPUT FORMAT:
    ```json
    {
      "check_type": "accuracy",
      "score": "X% verified",
      "findings": {
        "relationships": {
          "total_documented": 25,
          "verified_correct": 22,
          "incorrect": [
            {
              "documented": {"from": "auth", "to": "database", "type": "SQL"},
              "actual": "auth does not import database directly",
              "evidence": "Checked ingenious/auth/*.py - no database imports"
            }
          ],
          "missing_in_docs": [
            {"from": "auth", "to": "cache", "evidence": "ingenious/auth/jwt.py imports cache"}
          ]
        },
        "technology_labels": {
          "correct": ["FastAPI 0.100+", "Python 3.13"],
          "incorrect": [
            {
              "documented": "SQLite",
              "actual": "Supports SQLite, PostgreSQL, and Azure SQL",
              "evidence": "ingenious/db/connection.py supports multiple backends"
            }
          ]
        },
        "hierarchy_placement": {
          "misplaced": [
            {
              "element": "CacheClient",
              "current_location": "api-server/components/auth/code/",
              "correct_location": "api-server/components/cache/code/",
              "evidence": "CacheClient is in ingenious/cache/, not ingenious/auth/"
            }
          ]
        },
        "naming": {
          "incorrect_names": [
            {
              "documented_name": "AuthService",
              "actual_name": "AuthenticationHandler",
              "file": "ingenious/auth/handler.py"
            }
          ],
          "broken_paths": [
            {
              "documented_path": "ingenious/services/old_module/",
              "error": "Path does not exist"
            }
          ]
        }
      },
      "issues": [
        {
          "id": "ACC-001",
          "severity": "medium",
          "category": "incorrect_relationship",
          "description": "auth->database relationship doesn't exist in code",
          "location": "codemap/.../auth/component.puml",
          "fix": "Remove Rel(auth, database, ...) from diagram"
        }
      ]
    }
    ```
```

### Subagent 3: Hierarchy Validation

```
Tool: Task
Parameters:
  subagent_type: "Explore"
  description: "Validate C4 hierarchy"
  prompt: |
    TASK: Verify STRUCTURAL INTEGRITY of the C4 folder hierarchy.

    SYSTEM_ID: <from Phase 0>
    EXISTING HIERARCHY:
    <insert file listing from Phase 0>

    STRUCTURAL DIMENSIONS:

    1. REQUIRED FILES:
       Each level must have specific files:
       - System level: context.puml, context.md
       - Container level: container.puml, container.md
       - Component level: component.puml, component.md
       - Code level: classes.puml, classes.md

    2. FOLDER STRUCTURE:
       - No orphan folders (folders without required files)
       - No empty containers (containers must have components)
       - Consistent nesting depth

    3. CROSS-LEVEL CONSISTENCY:
       - Containers in context.puml should have matching folders
       - Components in container.puml should have matching folders
       - Classes in component.puml should have code/ documentation

    4. NAVIGATION LINKS:
       - All "Parent:" links resolve to existing files
       - All "Drill Down" links resolve to existing folders
       - Relative paths are correct

    5. ID CONSISTENCY:
       - Folder names match PlantUML element IDs
       - IDs are consistent across diagram levels
       - IDs are valid folder names (kebab-case)

    VALIDATION STRATEGY:
    - List all folders and check for required files
    - Read .md files and extract navigation links
    - Verify each link resolves to an existing file
    - Parse .puml files and extract element IDs
    - Compare IDs to folder names

    OUTPUT FORMAT:
    ```json
    {
      "check_type": "hierarchy",
      "score": "X/5 criteria met",
      "findings": {
        "required_files": {
          "missing": [
            {"folder": "codemap/.../components/metrics/", "missing_file": "component.puml"},
            {"folder": "codemap/.../components/metrics/", "missing_file": "component.md"}
          ]
        },
        "folder_structure": {
          "orphan_folders": ["codemap/.../components/old-module/"],
          "empty_containers": ["codemap/.../containers/legacy-service/"]
        },
        "cross_level_consistency": {
          "diagram_folder_mismatches": [
            {
              "diagram": "context.puml",
              "element_id": "worker",
              "expected_folder": "containers/worker/",
              "folder_exists": false
            }
          ]
        },
        "navigation_links": {
          "broken_parent_links": [
            {"file": "codemap/.../component.md", "link": "../../container.md", "error": "File not found"}
          ],
          "broken_child_links": [
            {"file": "codemap/.../container.md", "link": "./components/old/", "error": "Folder not found"}
          ]
        },
        "id_consistency": {
          "mismatches": [
            {
              "folder_name": "chat-services",
              "diagram_id": "chatServices",
              "file": "container.puml"
            }
          ]
        }
      },
      "issues": [
        {
          "id": "HIE-001",
          "severity": "high",
          "category": "missing_required_file",
          "description": "metrics component missing puml and md files",
          "location": "codemap/.../components/metrics/",
          "fix": "Create component.puml and component.md in metrics folder"
        }
      ]
    }
    ```
```

### Subagent 4: Diagram Quality Check

```
Tool: Task
Parameters:
  subagent_type: "Explore"
  description: "Validate C4 diagrams"
  prompt: |
    TASK: Verify DIAGRAM QUALITY of all C4 PlantUML files.

    SYSTEM_ID: <from Phase 0>
    EXISTING HIERARCHY:
    <insert file listing from Phase 0>

    QUALITY DIMENSIONS:

    1. PLANTUML SYNTAX:
       - Valid @startuml/@enduml blocks
       - Correct C4-PlantUML !include statements
       - No Mermaid or other syntax mixed in

    2. CORRECT INCLUDES PER LEVEL:
       - context.puml: !include ...C4_Context.puml
       - container.puml: !include ...C4_Container.puml
       - component.puml: !include ...C4_Component.puml
       - classes.puml: Standard PlantUML (no C4 include needed)

    3. CORRECT MACROS PER LEVEL:
       - Context: Person(), System(), System_Ext(), Rel()
       - Container: Container(), ContainerDb(), ContainerQueue(), Rel()
       - Component: Component(), Rel()
       - Code: class, interface, abstract, Rel or arrows

    4. ELEMENT COVERAGE:
       - No overloaded diagrams (>15 elements)
       - No orphan elements (elements without relationships)
       - Balanced coverage across levels

    5. RELATIONSHIP COMPLETENESS:
       - Every element has at least one relationship
       - Relationships have descriptions
       - Protocol/technology labels are present

    VALIDATION STRATEGY:
    - Read each .puml file
    - Check @startuml/@enduml presence
    - Verify !include matches file level
    - Count elements and relationships
    - Identify orphan elements

    OUTPUT FORMAT:
    ```json
    {
      "check_type": "diagram_quality",
      "score": "X/5 criteria met",
      "findings": {
        "syntax": {
          "valid_files": 15,
          "invalid_files": [
            {"file": "codemap/.../component.puml", "error": "Missing @enduml"}
          ]
        },
        "includes": {
          "correct": 12,
          "incorrect": [
            {
              "file": "codemap/.../container.puml",
              "current_include": "C4_Context.puml",
              "expected_include": "C4_Container.puml"
            }
          ]
        },
        "macros": {
          "correct_usage": 14,
          "incorrect_usage": [
            {
              "file": "codemap/.../context.puml",
              "issue": "Using Container() macro in context diagram",
              "fix": "Use System() for internal systems at context level"
            }
          ]
        },
        "coverage": {
          "overloaded_diagrams": [
            {"file": "codemap/.../component.puml", "element_count": 23, "max_recommended": 15}
          ],
          "sparse_diagrams": [
            {"file": "codemap/.../code/classes.puml", "element_count": 1}
          ]
        },
        "relationships": {
          "orphan_elements": [
            {"file": "codemap/.../container.puml", "element": "LegacyService", "has_relationships": false}
          ],
          "missing_descriptions": [
            {"file": "codemap/.../context.puml", "relationship": "Rel(user, system, ???)"}
          ]
        }
      },
      "issues": [
        {
          "id": "DIA-001",
          "severity": "low",
          "category": "wrong_include",
          "description": "container.puml using C4_Context.puml include",
          "location": "codemap/.../containers/api-server/container.puml",
          "fix": "Change include to C4_Container.puml"
        }
      ]
    }
    ```
```

**WAIT for ALL FOUR subagents to complete before proceeding to Phase 2.**

---

## PHASE 2: Synthesis and Issue Prioritization

This phase analyzes outputs from all four verification subagents to:
1. Find **intersections** - issues reported by multiple checks (higher confidence)
2. Identify **conflicts** - contradictory findings between checks
3. **Prioritize** issues by severity and frequency
4. Create a **unified correction plan** with proper ordering

```
Tool: Task
Parameters:
  subagent_type: "Explore"
  description: "Synthesize verification"
  prompt: |
    TASK: Synthesize findings from all four verification checks.

    VERIFICATION OUTPUTS:
    - Completeness Check: <insert full output from Subagent 1>
    - Accuracy Check: <insert full output from Subagent 2>
    - Hierarchy Check: <insert full output from Subagent 3>
    - Diagram Check: <insert full output from Subagent 4>

    SYNTHESIS GOALS:

    1. FIND INTERSECTIONS:
       Issues reported by multiple checks are higher confidence.
       Example: If completeness says "metrics component missing" AND
       hierarchy says "metrics folder has no files" -> same root issue.

    2. IDENTIFY CONFLICTS:
       Contradictory findings reveal model inconsistencies.
       Example: Accuracy says "auth->database exists" but
       Hierarchy says "database folder doesn't exist" -> conflict.

    3. ROOT CAUSE ANALYSIS:
       Multiple issues may stem from one root cause.
       Example: Missing container -> causes missing components ->
       causes missing code -> causes broken navigation links.

    4. PRIORITIZE ISSUES:
       Priority factors:
       - Severity (error > warning > info)
       - Frequency (reported by N checks)
       - Cascade impact (fixing one fixes others)
       - Structural vs content (structural first)

    5. DETERMINE FIX ORDER:
       Dependency order for fixes:
       - Structural changes (create/delete folders) FIRST
       - Parent-level fixes before child-level fixes
       - Diagram fixes before navigation fixes
       - Content updates LAST

    OUTPUT FORMAT:
    ```json
    {
      "synthesis_summary": {
        "total_unique_issues": 15,
        "intersections_found": 3,
        "conflicts_found": 1,
        "root_causes_identified": 2
      },
      "intersections": [
        {
          "issue_ids": ["COMP-001", "HIE-003"],
          "description": "metrics component missing - reported by completeness and hierarchy checks",
          "unified_issue": {
            "id": "UNIFIED-001",
            "severity": "high",
            "description": "metrics component not documented",
            "root_cause": "New metrics module added to codebase but not to C4 model",
            "single_fix": "Create metrics component folder with puml and md files"
          }
        }
      ],
      "conflicts": [
        {
          "check_a": {"id": "ACC-005", "claim": "CacheClient belongs in auth component"},
          "check_b": {"id": "HIE-007", "claim": "CacheClient documented in cache component"},
          "resolution": "CacheClient is in ingenious/cache/, so cache component is correct. ACC-005 is a false positive.",
          "action": "Dismiss ACC-005"
        }
      ],
      "root_causes": [
        {
          "id": "ROOT-001",
          "description": "Worker container not documented",
          "downstream_issues": ["COMP-002", "HIE-005", "DIA-003"],
          "fix_once": "Create worker container folder with proper structure"
        }
      ],
      "prioritized_issues": [
        {
          "priority": 1,
          "original_ids": ["COMP-001", "HIE-003", "ROOT-001"],
          "unified_id": "FIX-001",
          "severity": "high",
          "category": "structural",
          "description": "Create missing worker container",
          "fix_type": "create_structure",
          "dependencies": [],
          "downstream_fixes": ["FIX-002", "FIX-003"]
        },
        {
          "priority": 2,
          "original_ids": ["COMP-004"],
          "unified_id": "FIX-002",
          "severity": "high",
          "category": "structural",
          "description": "Create worker components",
          "fix_type": "create_structure",
          "dependencies": ["FIX-001"],
          "downstream_fixes": ["FIX-005"]
        }
      ],
      "correction_plan": {
        "phase_1_structural": [
          {"fix_id": "FIX-001", "action": "mkdir -p codemap/.../containers/worker/components"},
          {"fix_id": "FIX-002", "action": "mkdir -p codemap/.../components/metrics/code"}
        ],
        "phase_2_diagrams": [
          {"fix_id": "FIX-003", "action": "Create worker/container.puml"},
          {"fix_id": "FIX-004", "action": "Fix include in api-server/container.puml"}
        ],
        "phase_3_documentation": [
          {"fix_id": "FIX-005", "action": "Create worker/container.md with navigation"},
          {"fix_id": "FIX-006", "action": "Update context.md drill-down table"}
        ],
        "phase_4_navigation": [
          {"fix_id": "FIX-007", "action": "Fix broken parent link in component.md"}
        ]
      },
      "dismissed_issues": [
        {"id": "ACC-005", "reason": "False positive - resolved by conflict analysis"}
      ]
    }
    ```
```

**Review synthesis output before proceeding to Phase 3.**

---

## PHASE 3: Apply Fixes

Execute fixes in the order specified by the correction plan from Phase 2.

### Step 3A: Structural Fixes (create/delete folders)

```bash
# Create missing folders from correction_plan.phase_1_structural
for fix in <phase_1_structural fixes>; do
  mkdir -p <path>
done

# Remove orphan folders if any
for orphan in <orphan folders>; do
  rm -rf <path>
done
```

### Step 3B: Diagram Fixes

For each diagram fix, spawn a focused subagent:

```
Tool: Task
Parameters:
  subagent_type: "Explore"
  description: "Fix C4 diagram"
  model: "haiku"
  prompt: |
    TASK: Fix specific issues in a C4 diagram.

    FILE: <path to .puml file>
    CURRENT CONTENT:
    <read and insert current file content>

    FIXES TO APPLY:
    <insert relevant fixes from correction_plan.phase_2_diagrams>

    RULES:
    - Only modify what's specified in FIXES
    - Preserve all other content exactly
    - Ensure proper C4-PlantUML syntax
    - Use correct !include for this level

    OUTPUT:
    - Complete updated file content (full file, not diff)
```

### Step 3C: Documentation Fixes

For missing documentation, spawn analysis subagents:

**For missing container documentation:**
```
Tool: Task
Parameters:
  subagent_type: "Explore"
  description: "Document container"
  prompt: |
    TASK: Create documentation for an undocumented container.

    CONTAINER_ID: <container-id>
    SOURCE_PATH: <path to container source code>
    PARENT CONTEXT:
    <read context.md for navigation template>

    ANALYSIS GOALS:
    1. Analyze the container's source code
    2. Identify technology stack
    3. Find components within this container
    4. Map relationships to other containers

    OUTPUT:
    - container.puml (C4 Container diagram showing this container's place)
    - container.md (documentation with navigation links)
    - List of components to document next
```

**For missing component documentation:**
```
Tool: Task
Parameters:
  subagent_type: "Explore"
  description: "Document component"
  prompt: |
    TASK: Create documentation for an undocumented component.

    COMPONENT_ID: <component-id>
    CONTAINER_ID: <container-id>
    SOURCE_PATH: <path to component source code>
    PARENT CONTAINER:
    <read parent container.md for context>

    ANALYSIS GOALS:
    1. Analyze the component's source code
    2. Identify responsibility
    3. Find key classes
    4. Map dependencies

    OUTPUT:
    - component.puml (C4 Component diagram)
    - component.md (documentation with navigation links)
    - List of key classes for code/ documentation
```

### Step 3D: Navigation Fixes

Fix broken links in markdown files:

```
Tool: Task
Parameters:
  subagent_type: "Explore"
  description: "Fix navigation"
  model: "haiku"
  prompt: |
    TASK: Fix navigation links in markdown files.

    FILES TO FIX:
    <list of files with broken links from correction_plan.phase_4_navigation>

    FOR EACH FILE:
    - Current content: <read file>
    - Broken links: <list from synthesis>
    - Correct paths: <calculated from folder structure>

    RULES:
    - Fix only the broken links
    - Update drill-down tables to match actual folder contents
    - Ensure relative paths are correct for file location

    OUTPUT:
    - Updated file contents for each file (full files)
```

---

## PHASE 4: Re-Verification

Quick verification pass to confirm fixes worked.

```
Tool: Task
Parameters:
  subagent_type: "Explore"
  description: "Re-verify fixes"
  model: "haiku"
  prompt: |
    TASK: Verify that all fixes from Phase 3 were applied correctly.

    FIXES APPLIED:
    <list from Phase 3>

    VERIFICATION CHECKS:

    1. STRUCTURAL:
       - All created folders exist
       - All orphan folders removed
       - Required files present in new folders

    2. DIAGRAMS:
       - Fixed files have correct syntax
       - Correct !include statements
       - No new errors introduced

    3. NAVIGATION:
       - Previously broken links now resolve
       - Drill-down tables accurate

    OUTPUT FORMAT:
    ```json
    {
      "verification_passed": true/false,
      "fixes_confirmed": ["FIX-001", "FIX-002", ...],
      "fixes_failed": [
        {"fix_id": "FIX-005", "reason": "File not created", "action_needed": "Manual creation"}
      ],
      "new_issues_found": [],
      "overall_status": "PASS|PARTIAL|FAIL"
    }
    ```
```

---

## PHASE 5: Finalization

### Step 5A: Regenerate PNG Diagrams

```bash
# Regenerate all PNGs (or only modified ones)
find codemap -name "*.puml" -exec plantuml -tpng {} \;
```

### Step 5B: Write Verification Report

Create `codemap/VERIFICATION.md`:

```markdown
# C4 Verification Report

<!-- Verified: YYYY-MM-DD -->

## System: <system-id>

## Summary

| Metric | Value |
|--------|-------|
| Total Issues Found | X |
| Intersections (multi-check) | Y |
| Conflicts Resolved | Z |
| Issues Fixed | W |
| Issues Remaining | V |

## Verification Results

### Completeness: X/4
[Summary from Subagent 1]

### Accuracy: X% verified
[Summary from Subagent 2]

### Hierarchy Integrity: X/5
[Summary from Subagent 3]

### Diagram Quality: X/5
[Summary from Subagent 4]

## Synthesis Findings

### Intersections (High Confidence Issues)
| Issue | Reported By | Resolution |
|-------|-------------|------------|
| [desc] | Completeness, Hierarchy | Fixed |

### Conflicts Resolved
| Check A | Check B | Resolution |
|---------|---------|------------|
| ACC-005 | HIE-007 | ACC-005 dismissed (false positive) |

### Root Causes Identified
| Root Cause | Downstream Issues | Status |
|------------|-------------------|--------|
| Missing worker container | COMP-002, HIE-005, DIA-003 | Fixed |

## Corrections Applied

### Phase 1: Structural
- [x] Created codemap/.../containers/worker/
- [x] Created codemap/.../components/metrics/

### Phase 2: Diagrams
- [x] Fixed include in api-server/container.puml
- [x] Created worker/container.puml

### Phase 3: Documentation
- [x] Created worker/container.md
- [x] Updated context.md drill-down table

### Phase 4: Navigation
- [x] Fixed parent link in auth/component.md

## Re-Verification Status

| Check | Status |
|-------|--------|
| Structural fixes | PASS |
| Diagram fixes | PASS |
| Navigation fixes | PASS |

## Remaining Issues

[List any issues that couldn't be auto-fixed]

## Manual Review Needed

[List items requiring human decision]
```

### Step 5C: Update README

Update `codemap/README.md` with verification timestamp.

---

## Output Summary

```markdown
# C4 Verification Complete

## Overall Status: PASS/PARTIAL/FAIL

## Verification Scores
- Completeness: X/4
- Accuracy: X%
- Hierarchy: X/5
- Diagram Quality: X/5

## Synthesis Summary
- Issues found: X
- Intersections (high confidence): Y
- Conflicts resolved: Z
- Root causes identified: W

## Fixes Applied
- Structural: X folders created/removed
- Diagrams: Y files fixed
- Documentation: Z files created
- Navigation: W links fixed

## Report Location
codemap/VERIFICATION.md

## Re-Verification: PASS/FAIL

## Diagrams Regenerated
```bash
find codemap -name "*.puml" -exec plantuml -tpng {} \;
```
```

---

## Error Handling

**If Phase 1 subagent fails:**
- Report which check failed
- Continue with other checks
- Note incomplete verification in report

**If Phase 2 synthesis finds irreconcilable conflicts:**
- List conflicts requiring human decision
- Do not auto-fix conflicting issues
- Proceed with non-conflicting fixes

**If Phase 3 fix fails:**
- Log the failure
- Continue with independent fixes
- Report partial success

**If Phase 4 re-verification fails:**
- List failed fixes
- Suggest manual intervention
- Do not claim success
